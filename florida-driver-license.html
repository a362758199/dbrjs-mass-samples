<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
<body>
    <label style="position:fixed;left:0;bottom:0;z-index:1;">
        <input id="ipt-useSpecialRuntimeSettings" type="checkbox">Use Special RuntimeSettings
    </label>
    <script src="https://cdn.jsdelivr.net/npm/dynamsoft-javascript-barcode@9.6.20/dist/dbr.js"></script>
    <script>
        // Specifies a license, you can visit https://www.dynamsoft.com/customer/license/trialLicense?ver=9.6.20&utm_source=github&product=dbr&package=js to get your own trial license good for 30 days. 
        Dynamsoft.DBR.BarcodeScanner.license = 'DLS2eyJvcmdhbml6YXRpb25JRCI6IjIwMDAwMSJ9';
        // Initializes and uses the SDK
        let scanner = null;
        let bUseSpecialRuntimeSettings = false;
        (async () => {
            scanner = await Dynamsoft.DBR.BarcodeScanner.createInstance();
            let lastFrameTime = Date.now();
            let lastDecodeCost = 0;
            scanner.onFrameRead = results => {
              let now = Date.now();
              lastDecodeCost = now - lastFrameTime;
              lastFrameTime = now;
              if (results.length > 0) console.log(results);
            };
            scanner.onUniqueRead = (txt, result) => {
              alert(`decode time: ${lastDecodeCost}ms\ntxt: ${txt}`);
            };
            await useRuntimeSettings();
            await chooseBetterCamera4IPhone14Pro(scanner);
            await scanner.show();
            await scanner.setResolution(1920, 1080);
        })();

        document.getElementById('ipt-useSpecialRuntimeSettings').addEventListener('change', async function(){
            bUseSpecialRuntimeSettings = this.checked;
            await useRuntimeSettings();
        });

        const useRuntimeSettings = async()=>{
            if(!scanner){ return; }

            // https://www.dynamsoft.com/barcode-reader/docs/core/programming/usecases/scan-and-parse-AAMVA.html?ver=9.6.20&utm_source=github&&lang=js
            await scanner.updateRuntimeSettings("dense");
            let rs = await scanner.getRuntimeSettings();
            // Sets the barcode type to PDF417.
            rs.barcodeFormatIds = Dynamsoft.DBR.EnumBarcodeFormat.BF_PDF417;
            // Sets the scale-up mode.
            rs.scaleUpModes[0] = Dynamsoft.DBR.EnumScaleUpMode.SUM_LINEAR_INTERPOLATION;
            await scanner.updateRuntimeSettings(rs);
            // Fine-tunes some arguments of the first mode in `scaleUpModes`
            scanner.setModeArgument("scaleUpModes", 0, "AcuteAngleWithXThreshold", "0");
            scanner.setModeArgument("scaleUpModes", 0, "ModuleSizeThreshold", "3");
            scanner.setModeArgument("scaleUpModes", 0, "TargetModuleSize", "8");
            
            if(!bUseSpecialRuntimeSettings){ return; }
            rs.furtherModes.imagePreprocessingModes[1] = Dynamsoft.DBR.EnumImagePreprocessingMode.IPM_SHARPEN_SMOOTH;
            //rs.localizationModes[2] = Dynamsoft.DBR.EnumLocalizationMode.LM_STATISTICS;
            await scanner.updateRuntimeSettings(rs);
            await scanner.setModeArgument("ImagePreprocessingModes",1,"SharpenBlockSizeX","3");
            await scanner.setModeArgument("ImagePreprocessingModes",1,"SharpenBlockSizeY","3");
            await scanner.setModeArgument("ImagePreprocessingModes",1,"SmoothBlockSizeX","3");
            await scanner.setModeArgument("ImagePreprocessingModes",1,"SmoothBlockSizeY","3");
            await scanner.setModeArgument("BinarizationModes",0,"BlockSizeX","10");
            await scanner.setModeArgument("BinarizationModes",0,"BlockSizeY","10");
            await scanner.setModeArgument("BinarizationModes",0,"EnableFillBinaryVacancy","1");
            await scanner.setModeArgument("BinarizationModes",0,"ThresholdCompensation","20");
        };

        const chooseBetterCamera4IPhone14Pro = async(scanner)=>{
            const environment =
              await Dynamsoft.DBR.BarcodeReader.detectEnvironment();
            console.log(environment.OS);
            const getDeviceResolution = () => {
              const width = window.devicePixelRatio * window.screen.width;
              const height = window.devicePixelRatio * window.screen.height;
              return { width, height };
            };
            const deviceResolution = getDeviceResolution();
            console.log(JSON.stringify(deviceResolution));
            if (
              // iPhone 14 Pro or iPhone 14 Pro Max
              environment.OS === "iPhone" &&
              ((deviceResolution.width == 1179 &&
                deviceResolution.height == 2556) ||
                (deviceResolution.width == 1290 &&
                  deviceResolution.height == 2796))
            ) {
              const backCameraKeywords = [
                "Back Camera",
                //TODO
              ];
              const backUltraWideCameraKeywords = [
                "Back Ultra Wide Camera",
                //TODO
              ];
              const backDualWideCameraKeywords = [
                "Back Dual Wide Camera",
                //TODO
              ];
              const backDualWideCameraKeywords = [
                "Back Triple Camera",
                //TODO
              ];
              const cameras = await scanner.getAllCameras();
              let goodCamera;
              let goodLv = 0;
              for (let camera of cameras) {
                const label = camera.label.toLowerCase();
                if(backDualWideCameraKeywords.some(k=>label.includes(k))){
                  goodCamera = camera;
                  goodLv = 4;
                  break;
                }
                if(goodLv < 3 && backDualWideCameraKeywords.some(k=>label.includes(k))){
                  goodCamera = camera;
                  goodLv = 3;
                  continue;
                }
                if(goodLv < 2 && backUltraWideCameraKeywords.some(k=>label.includes(k))){
                  goodCamera = camera;
                  goodLv = 2;
                  continue;
                }
                if(goodLv < 1 && backCameraKeywords.some(k=>label.includes(k))){
                  goodCamera = camera;
                  goodLv = 1;
                  continue;
                }
              }
              console.log(JSON.stringify(goodCamera));
              if (goodCamera) {
                await scanner.setCurrentCamera(goodCamera);
              }
            }
        };
    </script>
</body>

</html>
