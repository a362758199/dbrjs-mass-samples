!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).Dynamsoft=e.Dynamsoft||{},e.Dynamsoft.utils={}))}(this,(function(e){"use strict";function t(e,t,i,a){if("a"===i&&!a)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!a:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?a:"a"===i?a.call(e):a?a.value:t.get(e)}function i(e,t,i,a,r){if("m"===a)throw new TypeError("Private method is not writable");if("a"===a&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===a?r.call(e,i):r?r.value=i:t.set(e,i),i}"function"==typeof SuppressedError&&SuppressedError;const a="undefined"==typeof self;let r,s,o,n,h;function l(e,t,i,a){if("a"===i&&!a)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!a:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?a:"a"===i?a.call(e):a?a.value:t.get(e)}function d(e,t,i,a,r){if("m"===a)throw new TypeError("Private method is not writable");if("a"===a&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===a?r.call(e,i):r?r.value=i:t.set(e,i),i}"undefined"!=typeof navigator&&(r=navigator,s=r.userAgent,o=r.platform,n=r.mediaDevices),function(){if(!a){const e={Edge:{search:"Edg",verSearch:"Edg"},OPR:null,Chrome:null,Safari:{str:r.vendor,search:"Apple",verSearch:["Version","iPhone OS","CPU OS"]},Firefox:null,Explorer:{search:"MSIE",verSearch:"MSIE"}},t={HarmonyOS:null,Android:null,iPhone:null,iPad:null,Windows:{str:o,search:"Win"},Mac:{str:o},Linux:{str:o}};let i="unknownBrowser",a=0,n="unknownOS";for(let t in e){const r=e[t]||{};let o=r.str||s,n=r.search||t,h=r.verStr||s,l=r.verSearch||t;if(l instanceof Array||(l=[l]),-1!=o.indexOf(n)){i=t;for(let e of l){let t=h.indexOf(e);if(-1!=t){a=parseFloat(h.substring(t+e.length+1));break}}break}}for(let e in t){const i=t[e]||{};let a=i.str||s,r=i.search||e;if(-1!=a.indexOf(r)){n=e;break}}"Linux"==n&&-1!=s.indexOf("Windows NT")&&(n="HarmonyOS"),h={browser:i,version:a,OS:n}}a&&(h={browser:"ssr",version:0,OS:"ssr"})}(),"undefined"!=typeof WebAssembly&&s&&(!/Safari/.test(s)||/Chrome/.test(s)||/\(.+\s11_2_([2-6]).*\)/.test(s)),n&&n.getUserMedia,"Chrome"===h.browser&&h.version>66||"Safari"===h.browser&&h.version>13||"OPR"===h.browser&&h.version>43||"Edge"===h.browser&&h.version,"function"==typeof SuppressedError&&SuppressedError;class c{static multiply(e,t){const i=[];for(let a=0;a<3;a++){const r=t.slice(3*a,3*a+3);for(let t=0;t<3;t++){const a=[e[t],e[t+3],e[t+6]].reduce(((e,t,i)=>e+t*r[i]),0);i.push(a)}}return i}static identity(){return[1,0,0,0,1,0,0,0,1]}static translate(e,t,i){return c.multiply(e,[1,0,0,0,1,0,t,i,1])}static rotate(e,t){var i=Math.cos(t),a=Math.sin(t);return c.multiply(e,[i,-a,0,a,i,0,0,0,1])}static scale(e,t,i){return c.multiply(e,[t,0,0,0,i,0,0,0,1])}}var f,u,m,w,g,p,v,y;e.EnumPixelFormat=void 0,function(e){e.GREY="grey",e.GREY32="grey32",e.RGBA="rgba",e.RBGA="rbga",e.GRBA="grba",e.GBRA="gbra",e.BRGA="brga",e.BGRA="bgra"}(e.EnumPixelFormat||(e.EnumPixelFormat={}));class E{static get version(){return"1.1.0"}static checkWebGLSupport(){return null===document.createElement("canvas").getContext("webgl")?(d(E,f,!1,"f",u),!1):(d(E,f,!0,"f",u),!0)}get disposed(){return l(this,y,"f")}constructor(){m.set(this,e.EnumPixelFormat.RGBA),w.set(this,null),g.set(this,null),p.set(this,null),this.useWebGLByDefault=!0,this._reusedCvs=null,this._reusedWebGLCvs=null,v.set(this,null),y.set(this,!1)}drawImage(t,i,a,r,s,o){if(this.disposed)throw Error("The 'ImageDataGetter' instance has been disposed.");if(!a||!r)throw new Error("Invalid 'sourceWidth' or 'sourceHeight'.");if(null==l(E,f,"f",u)&&E.checkWebGLSupport(),(null==o?void 0:o.bUseWebGL)&&!l(E,f,"f",u))throw new Error("Your browser or machine may not support WebGL.");if(i instanceof HTMLVideoElement&&4!==i.readyState||i instanceof HTMLImageElement&&!i.complete)throw new Error("The source is not loaded.");let n;E._onLog&&(n=Date.now(),E._onLog("drawImage(), START: "+n));let h=0,v=0,y=a,b=r,_=0,x=0,C=a,P=r;s&&(s.sx&&(h=Math.round(s.sx)),s.sy&&(v=Math.round(s.sy)),s.sWidth&&(y=Math.round(s.sWidth)),s.sHeight&&(b=Math.round(s.sHeight)),s.dx&&(_=Math.round(s.dx)),s.dy&&(x=Math.round(s.dy)),s.dWidth&&(C=Math.round(s.dWidth)),s.dHeight&&(P=Math.round(s.dHeight)));let S,L=e.EnumPixelFormat.RGBA;if((null==o?void 0:o.pixelFormat)&&(L=o.pixelFormat),(null==o?void 0:o.bufferContainer)&&(S=o.bufferContainer,S.length<4*C*P))throw new Error("Unexpected size of the 'bufferContainer'.");const T=t;if(!l(E,f,"f",u)||!(this.useWebGLByDefault&&null==(null==o?void 0:o.bUseWebGL)||(null==o?void 0:o.bUseWebGL))){E._onLog&&E._onLog("drawImage() in context2d."),T.ctx2d||(T.ctx2d=T.getContext("2d",{willReadFrequently:!0}));const t=T.ctx2d;if(!t)throw new Error("Unable to get 'CanvasRenderingContext2D' from canvas.");return(T.width<_+C||T.height<x+P)&&(T.width=_+C,T.height=x+P),t.drawImage(i,h,v,y,b,_,x,C,P),E._onLog&&E._onLog("drawImage() in context2d end. Costs: "+(Date.now()-n)),{context:t,pixelFormat:e.EnumPixelFormat.RGBA,bUseWebGL:!1}}E._onLog&&E._onLog("drawImage() in WebGL.");try{(T.width<_+C||T.height<x+P)&&(T.width=_+C,T.height=x+P,T.ctxWebGL&&T.ctxWebGL.viewport(0,0,_+C,x+P));const t=T.ctxWebGL||T.getContext("webgl",{antialias:!1})||T.getContext("experimental-webgl",{antialias:!1});if(!t){E._onLog&&E._onLog("Browser or machine may not support WebGL, or the canvas has already been set to a different context mode.");const e=new Error("Unable to get 'WebGLRenderingContext'. Your browser or machine may not support WebGL, or the canvas has already been set to a different context mode.");throw e.name="WebGLError",e}if(!T.ctxWebGL||L!==l(this,m,"f")){T.ctxWebGL=t;const e=e=>{const t=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,t),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,0,0,1,1,1]),e.STATIC_DRAW);const i=e.createBuffer();return e.bindBuffer(e.ARRAY_BUFFER,i),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,0,0,1,1,1]),e.STATIC_DRAW),{positions:t,texCoords:i}},i=e=>{const t=e.createTexture();return e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),t},a=(e,t)=>{const i=e.createProgram();if(t.forEach((t=>e.attachShader(i,t))),e.linkProgram(i),!e.getProgramParameter(i,e.LINK_STATUS)){const t=new Error(`An error occured linking the program: ${e.getProgramInfoLog(i)}.`);throw t.name="WebGLError",t}return e.useProgram(i),i},r=(e,t,i)=>{const a=e.createShader(t);if(e.shaderSource(a,i),e.compileShader(a),!e.getShaderParameter(a,e.COMPILE_STATUS)){const t=new Error(`An error occured compiling the shader: ${e.getShaderInfoLog(a)}.`);throw t.name="WebGLError",t}return a},s="\n                  attribute vec2 a_position;\n                  attribute vec2 a_texCoord;\n  \n                  uniform mat3 u_matrix;\n                  uniform mat3 u_textureMatrix;\n  \n                  varying vec2 v_texCoord;\n                  void main(void) {\n                  gl_Position = vec4((u_matrix * vec3(a_position, 1)).xy, 0, 1.0);\n                  v_texCoord = vec4((u_textureMatrix * vec3(a_texCoord, 1)).xy, 0, 1.0).xy;\n                  }\n              ";let o="rgb";["rgba","rbga","grba","gbra","brga","bgra"].includes(L)&&(o=L.slice(0,3));const n=`\n                  precision mediump float;\n                  varying vec2 v_texCoord;\n                  uniform sampler2D u_image;\n                  uniform float uColorFactor;\n  \n                  void main() {\n                      vec4 sample = texture2D(u_image, v_texCoord);\n                      float grey = 0.21 * sample.r + 0.71 * sample.g + 0.07 * sample.b;\n                      gl_FragColor = vec4(sample.${o} * (1.0 - uColorFactor) + (grey * uColorFactor), sample.a);\n                  }\n              `,h=a(t,[r(t,t.VERTEX_SHADER,s),r(t,t.FRAGMENT_SHADER,n)]);d(this,g,{program:h,attribLocations:{vertexPosition:t.getAttribLocation(h,"a_position"),texPosition:t.getAttribLocation(h,"a_texCoord")},uniformLocations:{uSampler:t.getUniformLocation(h,"u_image"),uColorFactor:t.getUniformLocation(h,"uColorFactor"),uMatrix:t.getUniformLocation(h,"u_matrix"),uTextureMatrix:t.getUniformLocation(h,"u_textureMatrix")}},"f"),d(this,p,e(t),"f"),d(this,w,i(t),"f"),d(this,m,L,"f")}const s=(e,t,i)=>{e.bindBuffer(e.ARRAY_BUFFER,t),e.enableVertexAttribArray(i),e.vertexAttribPointer(i,2,e.FLOAT,!1,0,0)},o=(e,t,i)=>{const a=e.RGBA,r=e.RGBA,s=e.UNSIGNED_BYTE;e.bindTexture(e.TEXTURE_2D,t),e.texImage2D(e.TEXTURE_2D,0,a,r,s,i)},f=(t,i,o,n)=>{t.clearColor(0,0,0,1),t.clearDepth(1),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),s(t,o.positions,i.attribLocations.vertexPosition),s(t,o.texCoords,i.attribLocations.texPosition),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,n),t.uniform1i(i.uniformLocations.uSampler,0),t.uniform1f(i.uniformLocations.uColorFactor,[e.EnumPixelFormat.GREY,e.EnumPixelFormat.GREY32].includes(L)?1:0);let l,d,f=c.translate(c.identity(),-1,-1);f=c.scale(f,2,2),f=c.scale(f,1/t.canvas.width,1/t.canvas.height),l=c.translate(f,_,x),l=c.scale(l,C,P),t.uniformMatrix3fv(i.uniformLocations.uMatrix,!1,l),d=c.translate(c.identity(),h/a,v/r),d=c.scale(d,y/a,b/r),t.uniformMatrix3fv(i.uniformLocations.uTextureMatrix,!1,d),t.drawArrays(t.TRIANGLES,0,6)};o(t,l(this,w,"f"),i),f(t,l(this,g,"f"),l(this,p,"f"),l(this,w,"f"));const u=S||new Uint8Array(4*C*P);if(t.readPixels(_,x,C,P,t.RGBA,t.UNSIGNED_BYTE,u),255!==u[3]){E._onLog&&E._onLog("Incorrect WebGL drawing .");const e=new Error("WebGL error: incorrect drawing.");throw e.name="WebGLError",e}return E._onLog&&E._onLog("drawImage() in WebGL end. Costs: "+(Date.now()-n)),{context:t,pixelFormat:L===e.EnumPixelFormat.GREY?e.EnumPixelFormat.GREY32:L,bUseWebGL:!0}}catch(e){if(this.forceLoseContext(),null==(null==o?void 0:o.bUseWebGL))return E._onLog&&E._onLog("'drawImage()' in WebGL failed, try again in context2d."),this.useWebGLByDefault=!1,this.drawImage(t,i,a,r,s,Object.assign({},o,{bUseWebGL:!1}));throw e.name="WebGLError",e}}readCvsData(e,t,i){if(!(e instanceof CanvasRenderingContext2D||e instanceof WebGLRenderingContext))throw new Error("Invalid 'context'.");let a,r=0,s=0,o=e.canvas.width,n=e.canvas.height;if(t&&(t.x&&(r=t.x),t.y&&(s=t.y),t.width&&(o=t.width),t.height&&(n=t.height)),(null==i?void 0:i.length)<4*o*n)throw new Error("Unexpected size of the 'bufferContainer'.");if(e instanceof WebGLRenderingContext){const t=e;i?(t.readPixels(r,s,o,n,t.RGBA,t.UNSIGNED_BYTE,i),a=new Uint8Array(i.buffer,0,4*o*n)):(a=new Uint8Array(4*o*n),t.readPixels(r,s,o,n,t.RGBA,t.UNSIGNED_BYTE,a))}else if(e instanceof CanvasRenderingContext2D){let t;t=e.getImageData(r,s,o,n),a=new Uint8Array(t.data.buffer),null==i||i.set(a)}return a}transformPixelFormat(t,i,a,r){let s,o;if(E._onLog&&(s=Date.now(),E._onLog("transformPixelFormat(), START: "+s)),i===a)return E._onLog&&E._onLog("transformPixelFormat() end. Costs: "+(Date.now()-s)),r?new Uint8Array(t):t;const n=[e.EnumPixelFormat.RGBA,e.EnumPixelFormat.RBGA,e.EnumPixelFormat.GRBA,e.EnumPixelFormat.GBRA,e.EnumPixelFormat.BRGA,e.EnumPixelFormat.BGRA];if(n.includes(i))if(a===e.EnumPixelFormat.GREY){o=new Uint8Array(t.length/4);for(let e=0;e<t.length;e+=4){const i=.21*t[e]+.71*t[e+1]+.07*t[e+2];o[e/4]=i}}else if(a===e.EnumPixelFormat.GREY32){o=r?new Uint8Array(t):t;for(let e=0;e<t.length;e+=4){const i=.21*t[e]+.71*t[e+1]+.07*t[e+2];o[e]=i,o[e+1]=i,o[e+2]=i}}else{if(!n.includes(a))throw new Error("Unable to transform.");if(r){o=new Uint8Array(t);const e=i.indexOf("r"),r=i.indexOf("g"),s=i.indexOf("b"),n=a.indexOf("r"),h=a.indexOf("g"),l=a.indexOf("b");for(let i=0;i<t.length;i+=4)o[i+n]=t[i+e],o[i+h]=t[i+r],o[i+l]=t[i+s]}else{o=t;const e=i.indexOf("r"),r=i.indexOf("g"),s=i.indexOf("b"),n=a.indexOf("r"),h=a.indexOf("g"),l=a.indexOf("b");for(let i=0;i<t.length;i+=4){let a=[t[i],t[i+1],t[i+2]];o[i+n]=a[e],o[i+h]=a[r],o[i+l]=a[s]}}}else if(i===e.EnumPixelFormat.GREY){if(a!==e.EnumPixelFormat.GREY32)throw new Error("Unable to transform.");o=new Uint8Array(4*t.length);for(let e=0;e<t.length;e++)o[4*e]=t[e],o[4*e+1]=t[e],o[4*e+2]=t[e],o[4*e+3]=255}else{if(i!==e.EnumPixelFormat.GREY32)throw new Error("Unable to transform.");if(a!==e.EnumPixelFormat.GREY)throw new Error("Unable to transform.");o=new Uint8Array(t.length/4);for(let e=0;e<t.length;e+=4)o[e/4]=t[e]}return E._onLog&&E._onLog("transformPixelFormat() end. Costs: "+(Date.now()-s)),o}getImageData(t,i,a,r,s){if(this.disposed)throw Error("The 'ImageDataGetter' instance has been disposed.");if(!i||!a)throw new Error("Invalid 'sourceWidth' or 'sourceHeight'.");if(null==l(E,f,"f",u)&&E.checkWebGLSupport(),(null==s?void 0:s.bUseWebGL)&&!l(E,f,"f",u))throw new Error("Your browser or machine may not support WebGL.");if(r.sx>i||r.sy>a||r.sx+r.sWidth>i||r.sy+r.sHeight>a)throw new Error("Invalid position.");if(t instanceof HTMLVideoElement&&4!==t.readyState||t instanceof HTMLImageElement&&!t.complete)throw new Error("The source is not loaded.");let o;E._onLog&&(o=Date.now(),E._onLog("getImageData(), START: "+o));const n=Math.round(r.sx),h=Math.round(r.sy),c=Math.round(r.sWidth),m=Math.round(r.sHeight),w=Math.round(r.dWidth),g=Math.round(r.dHeight);let p=e.EnumPixelFormat.RGBA;(null==s?void 0:s.pixelFormat)&&(p=s.pixelFormat);let y,b,_,x=null;if((null==s?void 0:s.bufferContainer)&&(x=s.bufferContainer),l(E,f,"f",u)&&(this.useWebGLByDefault&&null==(null==s?void 0:s.bUseWebGL)||(null==s?void 0:s.bUseWebGL))){E._onLog&&E._onLog("getImageData() in WebGL."),this._reusedWebGLCvs||(this._reusedWebGLCvs=document.createElement("canvas")),y=this._reusedWebGLCvs;try{if(x)if(p===e.EnumPixelFormat.GREY){if(_=new Uint8Array(4*w*g),b=this.drawImage(y,t,i,a,{sx:n,sy:h,sWidth:c,sHeight:m,dWidth:w,dHeight:g},{pixelFormat:p,bUseWebGL:!0,bufferContainer:_}),_=this.transformPixelFormat(_,b.pixelFormat,p),x){if(x.length<_.length)throw new Error("Unexpected size of the 'bufferContainer'.");x.set(_)}}else b=this.drawImage(y,t,i,a,{sx:n,sy:h,sWidth:c,sHeight:m,dWidth:w,dHeight:g},{pixelFormat:p,bUseWebGL:!0,bufferContainer:x}),_=new Uint8Array(x.buffer,0,4*w*g),_=this.transformPixelFormat(_,b.pixelFormat,p);else p===e.EnumPixelFormat.GREY?((!l(this,v,"f")||l(this,v,"f").length<4*w*g)&&d(this,v,new Uint8Array(4*w*g),"f"),_=new Uint8Array(l(this,v,"f").buffer,0,4*w*g)):_=new Uint8Array(4*w*g),b=this.drawImage(y,t,i,a,{sx:n,sy:h,sWidth:c,sHeight:m,dWidth:w,dHeight:g},{pixelFormat:p,bUseWebGL:!0,bufferContainer:_}),_=this.transformPixelFormat(_,b.pixelFormat,p)}catch(e){if("WebGLError"===e.name&&(this.forceLoseContext(),null==(null==s?void 0:s.bUseWebGL)))return E._onLog&&E._onLog("getImageData() in WebGL failed, try again in context2d."),this.useWebGLByDefault=!1,this.getImageData(t,i,a,{sx:n,sy:h,sWidth:c,sHeight:m,dWidth:w,dHeight:g},Object.assign({},s,{bUseWebGL:!1}));throw e}}else if(E._onLog&&E._onLog("getImageData() in context2d."),this._reusedCvs||(this._reusedCvs=document.createElement("canvas")),y=this._reusedCvs,b=this.drawImage(y,t,i,a,{sx:n,sy:h,sWidth:c,sHeight:m,dWidth:w,dHeight:g},{pixelFormat:e.EnumPixelFormat.RGBA,bUseWebGL:!1}),_=this.readCvsData(b.context,{width:w,height:g},null),_=this.transformPixelFormat(_,b.pixelFormat,p),x){if(x.length<_.length)throw new Error("Unexpected size of the 'bufferContainer'.");x.set(_)}return E._onLog&&E._onLog("getImageData() end. Costs: "+(Date.now()-o)),{data:_,pixelFormat:p,width:w,height:g,bUseWebGL:b.bUseWebGL}}convertDataToCvs(t,i,a,r){if(!(t instanceof Uint8Array||t instanceof Uint8ClampedArray))throw new TypeError("Invalid 'data'.");if("number"!=typeof i||i<=0)throw new Error("Invalid 'width'.");if("number"!=typeof a||a<=0)throw new Error("Invalid 'height'.");const s=document.createElement("canvas");let o;if(s.width=i,s.height=a,r===e.EnumPixelFormat.GREY){o=new Uint8ClampedArray(4*i*a);for(let e=0;e<o.length;e+=4)o[e]=t[e/4],o[e+1]=t[e/4],o[e+2]=t[e/4],o[e+3]=255}else o=new Uint8ClampedArray(t.buffer);const n=new ImageData(o,i,a);return s.getContext("2d").putImageData(n,0,0),s}forceLoseContext(){if(!this._reusedWebGLCvs)return;const e=this._reusedWebGLCvs.ctxWebGL;e&&!e.isContextLost()&&e.getExtension("WEBGL_lose_context")&&e.getExtension("WEBGL_lose_context").loseContext(),d(this,w,null,"f"),d(this,g,null,"f"),d(this,p,null,"f"),this._reusedWebGLCvs=null}dispose(){this.forceLoseContext(),d(this,y,!0,"f")}}f=E,m=new WeakMap,w=new WeakMap,g=new WeakMap,p=new WeakMap,v=new WeakMap,y=new WeakMap,u={value:void 0};const b=e=>{return null!==e&&"[object Object]"===(t=e,Object.prototype.toString.call(t));var t};var _,x,C,P,S,L,T,I,M,W,k,F,R,D,A,G,U,O,B,N,H,V,j,Y,J,z,X,$,q,Z,Q,K,ee,te,ie,ae,re,se,oe,ne,he,le,de;class ce{constructor(){_.set(this,new Map),x.set(this,!1)}get disposed(){return t(this,x,"f")}on(e,i){e=e.toLowerCase();const a=t(this,_,"f").get(e);if(a){if(a.includes(i))return;a.push(i)}else t(this,_,"f").set(e,[i])}off(e,i){e=e.toLowerCase();const a=t(this,_,"f").get(e);if(!a)return;const r=a.indexOf(i);-1!==r&&a.splice(r,1)}offAll(e){e=e.toLowerCase();const i=t(this,_,"f").get(e);i&&(i.length=0)}async fire(e,i=[],a={async:!1,copy:!0}){i||(i=[]),e=e.toLowerCase();const r=t(this,_,"f").get(e);if(r&&r.length){a=Object.assign({async:!1,copy:!0},a);for(let e of r){if(!e)continue;let t=[];if(a.copy)for(let e of i){try{e=JSON.parse(JSON.stringify(e))}catch(e){}t.push(e)}else t=i;let r=!1;if(a.async)setTimeout((()=>{this.disposed||e.apply(a.target,t)}),0);else try{r=await e.apply(a.target,t)}catch(e){}if(!0===r)break}}}dispose(){i(this,x,!0,"f")}}_=new WeakMap,x=new WeakMap;const fe=(e,t,i,a)=>{if(!i)return e;let r=t+Math.round((e-t)/i)*i;return a&&(r=Math.min(r,a)),r};class ue{static get version(){return"2.0.2"}static isStorageAvailable(e){let t;try{t=window[e];const i="__storage_test__";return t.setItem(i,i),t.removeItem(i),!0}catch(e){return e instanceof DOMException&&(22===e.code||1014===e.code||"QuotaExceededError"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name)&&t&&0!==t.length}}static findBestRearCameraInIOS(e,t){if(!e||!e.length)return null;let i=!1;if((null==t?void 0:t.getMainCamera)&&(i=!0),i){const t=["후면 카메라","背面カメラ","後置鏡頭","后置相机","กล้องด้านหลัง","बैक कैमरा","الكاميرا الخلفية","מצלמה אחורית","камера на задней панели","задня камера","задна камера","артқы камера","πίσω κάμερα","zadní fotoaparát","zadná kamera","tylny aparat","takakamera","stražnja kamera","rückkamera","kamera på baksidan","kamera belakang","kamera bak","hátsó kamera","fotocamera (posteriore)","câmera traseira","câmara traseira","cámara trasera","càmera posterior","caméra arrière","cameră spate","camera mặt sau","camera aan achterzijde","bagsidekamera","back camera","arka kamera"],i=e.find((e=>t.includes(e.label.toLowerCase())));return null==i?void 0:i.deviceId}{const t=["후면","背面","後置","后置","านหลัง","बैक","خلفية","אחורית","задняя","задней","задна","πίσω","zadní","zadná","tylny","trasera","traseira","taka","stražnja","spate","sau","rück","posteriore","posterior","hátsó","belakang","baksidan","bakre","bak","bagside","back","aртқы","arrière","arka","achterzijde"],i=["트리플","三镜头","三鏡頭","トリプル","สาม","ट्रिपल","ثلاثية","משולשת","үштік","тройная","тройна","потроєна","τριπλή","üçlü","trójobiektywowy","trostruka","trojný","trojitá","trippelt","trippel","triplă","triple","tripla","tiga","kolmois","ba camera"],a=["듀얼 와이드","雙廣角","双广角","デュアル広角","คู่ด้านหลังมุมกว้าง","ड्युअल वाइड","مزدوجة عريضة","כפולה רחבה","қос кең бұрышты","здвоєна ширококутна","двойная широкоугольная","двойна широкоъгълна","διπλή ευρεία","çift geniş","laajakulmainen kaksois","kép rộng mặt sau","kettős, széles látószögű","grande angular dupla","ganda","dwuobiektywowy","dwikamera","dvostruka široka","duální širokoúhlý","duálna širokouhlá","dupla grande-angular","dublă","dubbel vidvinkel","dual-weitwinkel","dual wide","dual con gran angular","dual","double","doppia con grandangolo","doble","dobbelt vidvinkelkamera"],r=e.filter((e=>{const i=e.label.toLowerCase();return t.some((e=>i.includes(e)))}));if(!r.length)return null;const s=r.find((e=>{const t=e.label.toLowerCase();return i.some((e=>t.includes(e)))}));if(s)return s.deviceId;const o=r.find((e=>{const t=e.label.toLowerCase();return a.some((e=>t.includes(e)))}));return o?o.deviceId:r[0].deviceId}}static findBestRearCamera(e,t){if(!e||!e.length)return null;if(["iPhone","iPad","Mac"].includes(h.OS))return ue.findBestRearCameraInIOS(e,{getMainCamera:null==t?void 0:t.getMainCameraInIOS});const i=["후","背面","背置","後面","後置","后面","后置","านหลัง","หลัง","बैक","خلفية","אחורית","задняя","задня","задней","задна","πίσω","zadní","zadná","tylny","trás","trasera","traseira","taka","stražnja","spate","sau","rück","rear","posteriore","posterior","hátsó","darrere","belakang","baksidan","bakre","bak","bagside","back","aртқы","arrière","arka","achterzijde"];for(let t of e){const e=t.label.toLowerCase();if(e&&i.some((t=>e.includes(t)))&&/\b0(\b)?/.test(e))return t.deviceId}return["Android","HarmonyOS"].includes(h.OS)?e[e.length-1].deviceId:null}static findBestCamera(e,t,i){return e&&e.length?"environment"===t?this.findBestRearCamera(e,i):"user"===t?null:t?void 0:null:null}static async playVideo(e,t,i){if(!e)throw new Error("Invalid 'videoEl'.");if(!t)throw new Error("Invalid 'source'.");return new Promise((async(a,r)=>{let s;const o=()=>{e.removeEventListener("loadstart",d),e.removeEventListener("abort",c),e.removeEventListener("play",f),e.removeEventListener("error",u),e.removeEventListener("loadedmetadata",g)};let n=!1;const h=()=>{n=!0,s&&clearTimeout(s),o(),a(e)},l=e=>{s&&clearTimeout(s),o(),r(e)},d=()=>{e.addEventListener("abort",c,{once:!0})},c=()=>{const e=new Error("Video playing was interrupted.");e.name="AbortError",l(e)},f=()=>{h()},u=()=>{l(new Error(`Video error ${e.error.code}: ${e.error.message}.`))};let m;const w=new Promise((e=>{m=e})),g=()=>{m()};if(e.addEventListener("loadstart",d,{once:!0}),e.addEventListener("play",f,{once:!0}),e.addEventListener("error",u,{once:!0}),e.addEventListener("loadedmetadata",g,{once:!0}),"string"==typeof t||t instanceof String?e.src=t:e.srcObject=t,e.autoplay&&await new Promise((e=>{setTimeout(e,1e3)})),!n){i&&(s=setTimeout((()=>{o(),r(new Error("Failed to play video. Timeout."))}),i));try{e.src&&await e.load(),await e.play(),h()}catch(t){ue._onLog&&ue._onLog("1st play error: "+((null==t?void 0:t.message)||t)),await w;try{await e.play(),h()}catch(e){ue._onLog&&ue._onLog("2rd play error: "+((null==e?void 0:e.message)||e)),l(e)}}}}))}static async testCameraAccess(e){var t,i;if(!(null===(i=null===(t=null===window||void 0===window?void 0:window.navigator)||void 0===t?void 0:t.mediaDevices)||void 0===i?void 0:i.getUserMedia))return{ok:!1,errorName:"InsecureContext",errorMessage:"Insecure context."};let a;try{a=e?await navigator.mediaDevices.getUserMedia(e):await navigator.mediaDevices.getUserMedia({video:!0})}catch(e){return{ok:!1,errorName:e.name,errorMessage:e.message}}finally{null==a||a.getTracks().forEach((e=>{e.stop()}))}return{ok:!0}}get state(){if(!t(this,G,"f"))return"closed";if("pending"===t(this,G,"f"))return"opening";if("fulfilled"===t(this,G,"f"))return"opened";throw new Error("Unknown state.")}set ifSaveLastUsedCamera(e){e?ue.isStorageAvailable("localStorage")?i(this,F,!0,"f"):(i(this,F,!1,"f"),console.warn("Local storage is unavailable")):i(this,F,!1,"f")}get ifSaveLastUsedCamera(){return t(this,F,"f")}get isVideoPlaying(){return!(!t(this,S,"f")||t(this,S,"f").paused)&&"opened"===this.state}set tapFocusEventBoundEl(e){var a,r,s;if(!(e instanceof HTMLElement)&&null!=e)throw new TypeError("Invalid 'element'.");null===(a=t(this,V,"f"))||void 0===a||a.removeEventListener("click",t(this,H,"f")),null===(r=t(this,V,"f"))||void 0===r||r.removeEventListener("touchend",t(this,H,"f")),null===(s=t(this,V,"f"))||void 0===s||s.removeEventListener("touchmove",t(this,N,"f")),i(this,V,e,"f"),e&&(window.TouchEvent&&["Android","HarmonyOS","iPhone","iPad"].includes(h.OS)?(e.addEventListener("touchend",t(this,H,"f")),e.addEventListener("touchmove",t(this,N,"f"))):e.addEventListener("click",t(this,H,"f")))}get tapFocusEventBoundEl(){return t(this,V,"f")}get disposed(){return t(this,Q,"f")}constructor(a){var r,s;P.add(this),S.set(this,null),L.set(this,void 0),T.set(this,(()=>{"opened"===this.state&&t(this,z,"f").fire("resumed",null,{target:this,async:!0})})),I.set(this,(()=>{t(this,z,"f").fire("paused",null,{target:this,async:!1})})),M.set(this,void 0),W.set(this,void 0),this.cameraOpenTimeout=15e3,this._arrCameras=[],k.set(this,void 0),F.set(this,!1),this.ifSkipCameraInspection=!1,this.selectIOSRearMainCameraAsDefault=!1,R.set(this,void 0),D.set(this,!0),A.set(this,void 0),G.set(this,void 0),U.set(this,!1),this._focusParameters={maxTimeout:400,minTimeout:300,kTimeout:void 0,oldDistance:null,fds:null,isDoingFocus:0,taskBackToContinous:null,curFocusTaskId:0,focusCancelableTime:1500,defaultFocusAreaSizeRatio:6,focusBackToContinousTime:5e3,tapFocusMinDistance:null,tapFocusMaxDistance:null,focusArea:null,tempBufferContainer:null,defaultTempBufferContainerLenRatio:1/4},O.set(this,!1),this._focusSupported=!0,this.calculateCoordInVideo=(e,i)=>{let a,r;const s=window.getComputedStyle(t(this,S,"f")).objectFit,o=this.getResolution(),n=t(this,S,"f").getBoundingClientRect(),h=n.left,l=n.top,{width:d,height:c}=t(this,S,"f").getBoundingClientRect();if(d<=0||c<=0)throw new Error("Unable to get video dimensions. Video may not be rendered on the page.");const f=d/c,u=o.width/o.height;let m=1;if("contain"===s)if(u>f){m=d/o.width,a=(e-h)/m;r=(i-l-(c-d/u)/2)/m}else{m=c/o.height,r=(i-l)/m;a=(e-h-(d-c*u)/2)/m}else{if("cover"!==s)throw new Error("Unsupported object-fit.");if(u>f){m=c/o.height,r=(i-l)/m;a=(e-h+(c*u-d)/2)/m}else{m=d/o.width,a=(e-h)/m;r=(i-l+(d/u-c)/2)/m}}return{x:a,y:r}},B.set(this,!1),N.set(this,(()=>{i(this,B,!0,"f")})),H.set(this,(async e=>{var a;if(t(this,B,"f"))return void i(this,B,!1,"f");if(!t(this,O,"f"))return;if(!this.isVideoPlaying)return;if(!t(this,L,"f"))return;if(!this._focusSupported)return;if(!this._focusParameters.fds&&(this._focusParameters.fds=null===(a=this.getCameraCapabilities())||void 0===a?void 0:a.focusDistance,!this._focusParameters.fds))return void(this._focusSupported=!1);if(null==this._focusParameters.kTimeout&&(this._focusParameters.kTimeout=(this._focusParameters.maxTimeout-this._focusParameters.minTimeout)/(1/this._focusParameters.fds.min-1/this._focusParameters.fds.max)),1==this._focusParameters.isDoingFocus)return;let r,s;if(this._focusParameters.taskBackToContinous&&(clearTimeout(this._focusParameters.taskBackToContinous),this._focusParameters.taskBackToContinous=null),e instanceof MouseEvent)r=e.clientX,s=e.clientY;else{if(!(e instanceof TouchEvent))throw new Error("Unknown event type.");if(!e.changedTouches.length)return;r=e.changedTouches[0].clientX,s=e.changedTouches[0].clientY}const o=this.getResolution(),n=2*Math.round(Math.min(o.width,o.height)/this._focusParameters.defaultFocusAreaSizeRatio/2);let h;try{h=this.calculateCoordInVideo(r,s)}catch(e){}if(h.x<0||h.x>o.width||h.y<0||h.y>o.height)return;const l={x:h.x+"px",y:h.y+"px"},d=n+"px",c=d;let f;ue._onLog&&(f=Date.now());try{await t(this,P,"m",he).call(this,l,d,c,this._focusParameters.tapFocusMinDistance,this._focusParameters.tapFocusMaxDistance)}catch(e){if(ue._onLog)throw ue._onLog(e),e}ue._onLog&&ue._onLog(`Tap focus costs: ${Date.now()-f} ms`),this._focusParameters.taskBackToContinous=setTimeout((()=>{var e;ue._onLog&&ue._onLog("Back to continuous focus."),null===(e=t(this,L,"f"))||void 0===e||e.applyConstraints({advanced:[{focusMode:"continuous"}]}).catch((()=>{}))}),this._focusParameters.focusBackToContinousTime),t(this,z,"f").fire("tapfocus",null,{target:this,async:!0})})),V.set(this,null),j.set(this,1),Y.set(this,{x:0,y:0}),this.updateVideoElWhenSoftwareScaled=()=>{if(!t(this,S,"f"))return;const e=t(this,j,"f");if(e<1)throw new RangeError("Invalid scale value.");if(1===e)t(this,S,"f").style.transform="";else{const i=window.getComputedStyle(t(this,S,"f")).objectFit,a=t(this,S,"f").videoWidth,r=t(this,S,"f").videoHeight,{width:s,height:o}=t(this,S,"f").getBoundingClientRect();if(s<=0||o<=0)throw new Error("Unable to get video dimensions. Video may not be rendered on the page.");const n=s/o,h=a/r;let l=1;"contain"===i?l=n<h?s/(a/e):o/(r/e):"cover"===i&&(l=h>n?o/(a/e):s/(r/e));const d=l*(1-1/e)*(a/2-t(this,Y,"f").x),c=l*(1-1/e)*(r/2-t(this,Y,"f").y);t(this,S,"f").style.transform=`translate(${d}px, ${c}px) scale(${e})`}},J.set(this,(function(){if(!(this.data instanceof Uint8Array||this.data instanceof Uint8ClampedArray))throw new TypeError("Invalid data.");if("number"!=typeof this.width||this.width<=0)throw new Error("Invalid width.");if("number"!=typeof this.height||this.height<=0)throw new Error("Invalid height.");const t=document.createElement("canvas");let i;t.width=this.width,t.height=this.height;if(this.pixelFormat===e.EnumPixelFormat.GREY){i=new Uint8ClampedArray(this.width*this.height*4);for(let e=0;e<i.length;e+=4)i[e]=this.data[e/4],i[e+1]=this.data[e/4],i[e+2]=this.data[e/4],i[e+3]=255}else i=new Uint8ClampedArray(this.data.buffer);const a=new ImageData(i,this.width,this.height);return t.getContext("2d").putImageData(a,0,0),t})),z.set(this,void 0),X.set(this,["before:open","opened","before:close","closed","before:camera:change","camera:changed","before:resolution:change","resolution:changed","played","paused","resumed","tapfocus"]),this.detectedResolutions=[{width:160,height:120},{width:320,height:240},{width:480,height:360},{width:640,height:480},{width:800,height:600},{width:960,height:720},{width:1280,height:720},{width:1920,height:1080},{width:2560,height:1440},{width:3840,height:2160}],$.set(this,new Map),q.set(this,!1),Z.set(this,(async()=>{var e,a;if("visible"===document.visibilityState){if(ue._onLog&&ue._onLog("document visible. video paused: "+(null===(e=t(this,S,"f"))||void 0===e?void 0:e.paused)),t(this,q,"f")&&t(this,S,"f")&&this.videoSrc&&"opened"===this.state)return void this.resume().catch((()=>{}));if(!this._mediaStream)return;if(this._mediaStream.active&&t(this,L,"f"))if(t(this,L,"f").muted&&["iPhone","iPad","Mac"].includes(h.OS)){if(h.version>=17)return void ue.playVideo(t(this,S,"f"),this._mediaStream,this.cameraOpenTimeout);await t(this,P,"m",ae).call(this)}else t(this,q,"f")&&this.resume().catch((()=>{}));else await t(this,P,"m",ae).call(this)}else if("hidden"===document.visibilityState&&(ue._onLog&&ue._onLog("document hidden. video paused: "+(null===(a=t(this,S,"f"))||void 0===a?void 0:a.paused)),["iPhone","iPad","Mac"].includes(h.OS)?i(this,q,!0,"f"):i(this,q,this.isVideoPlaying,"f"),this.isVideoLoaded()&&"opened"==this.state)){if(["iPhone","iPad","Mac"].includes(h.OS)&&h.version>=17)return;this.pause()}})),Q.set(this,!1),(null===(s=null===(r=null===window||void 0===window?void 0:window.navigator)||void 0===r?void 0:r.mediaDevices)||void 0===s?void 0:s.getUserMedia)||setTimeout((()=>{ue.onWarning&&ue.onWarning("The browser is too old or the page is loaded from an insecure origin.")}),0),this.defaultConstraints={video:{facingMode:{ideal:"environment"}}},this.resetMediaStreamConstraints(),a instanceof HTMLVideoElement&&this.setVideoEl(a),i(this,z,new ce,"f"),this.imageDataGetter=new E,document.addEventListener("visibilitychange",t(this,Z,"f"))}setVideoEl(e){if(!(e&&e instanceof HTMLVideoElement))throw new Error("Invalid 'videoEl'.");e.addEventListener("play",t(this,T,"f")),e.addEventListener("pause",t(this,I,"f")),i(this,S,e,"f")}getVideoEl(){return t(this,S,"f")}releaseVideoEl(){var e,a;null===(e=t(this,S,"f"))||void 0===e||e.removeEventListener("play",t(this,T,"f")),null===(a=t(this,S,"f"))||void 0===a||a.removeEventListener("pause",t(this,I,"f")),i(this,S,null,"f")}isVideoLoaded(){return!!t(this,S,"f")&&4==t(this,S,"f").readyState}async open(){if(t(this,A,"f")&&!t(this,D,"f")){if("pending"===t(this,G,"f"))return t(this,A,"f");if("fulfilled"===t(this,G,"f"))return}t(this,z,"f").fire("before:open",null,{target:this}),await t(this,P,"m",ae).call(this),t(this,z,"f").fire("opened",null,{target:this,async:!0}),t(this,z,"f").fire("played",null,{target:this,async:!0})}async close(){if("closed"===this.state)return;t(this,z,"f").fire("before:close",null,{target:this});const e=t(this,A,"f");if(t(this,P,"m",se).call(this),e&&"pending"===t(this,G,"f")){try{await e}catch(e){}if(!1===t(this,D,"f")){const e=new Error("'close()' was interrupted.");throw e.name="AbortError",e}}i(this,A,null,"f"),i(this,G,null,"f"),t(this,z,"f").fire("closed",null,{target:this,async:!0})}pause(){if(!this.isVideoLoaded())throw new Error("Video is not loaded.");if("opened"!==this.state)throw new Error("Camera or video is not open.");t(this,S,"f").pause()}async resume(){if(!this.isVideoLoaded())throw new Error("Video is not loaded.");if("opened"!==this.state)throw new Error("Camera or video is not open.");await t(this,S,"f").play()}async setCamera(e){if("string"!=typeof e)throw new TypeError("Invalid 'deviceId'.");if("object"!=typeof t(this,M,"f").video&&(t(this,M,"f").video={}),delete t(this,M,"f").video.facingMode,t(this,M,"f").video.deviceId={exact:e},!("closed"===this.state||this.videoSrc||"opening"===this.state&&t(this,D,"f"))){t(this,z,"f").fire("before:camera:change",[],{target:this,async:!1}),await t(this,P,"m",re).call(this);try{this.resetSoftwareScale()}catch(e){}return t(this,W,"f")}}async switchToFrontCamera(e){if("object"!=typeof t(this,M,"f").video&&(t(this,M,"f").video={}),(null==e?void 0:e.resolution)&&(t(this,M,"f").video.width={ideal:e.resolution.width},t(this,M,"f").video.height={ideal:e.resolution.height}),delete t(this,M,"f").video.deviceId,t(this,M,"f").video.facingMode={exact:"user"},i(this,k,null,"f"),!("closed"===this.state||this.videoSrc||"opening"===this.state&&t(this,D,"f"))){t(this,z,"f").fire("before:camera:change",[],{target:this,async:!1}),t(this,P,"m",re).call(this);try{this.resetSoftwareScale()}catch(e){}return t(this,W,"f")}}getCamera(){var e;if(t(this,W,"f"))return t(this,W,"f");{let i=(null===(e=t(this,M,"f").video)||void 0===e?void 0:e.deviceId)||"";if(i){i=i.exact||i.ideal||i;for(let e of this._arrCameras)if(e.deviceId===i)return JSON.parse(JSON.stringify(e))}return{deviceId:"",label:"",_checked:!1}}}async _getCameras(e){var t,i;if(!(null===(i=null===(t=null===window||void 0===window?void 0:window.navigator)||void 0===t?void 0:t.mediaDevices)||void 0===i?void 0:i.getUserMedia))throw new Error("Failed to access the camera because the browser is too old or the page is loaded from an insecure origin.");let a;if(e){let e=await navigator.mediaDevices.getUserMedia({video:!0});a=(await navigator.mediaDevices.enumerateDevices()).filter((e=>"videoinput"===e.kind)),e.getTracks().forEach((e=>{e.stop()}))}else a=(await navigator.mediaDevices.enumerateDevices()).filter((e=>"videoinput"===e.kind));const r=[],s=[];if(this._arrCameras)for(let e of this._arrCameras)e._checked&&s.push(e);for(let e=0;e<a.length;e++){let t,i=a[e];for(let e of s)if(i.deviceId==e.deviceId){t=e;break}t||(t={deviceId:i.deviceId,label:i.label?i.label:"camera "+e,_checked:!1}),t.deviceId&&r.push(t)}return this._arrCameras=r,ue._onLog&&ue._onLog(JSON.stringify(this._arrCameras)),r}async getCameras(){var e,t;if(!(null===(t=null===(e=null===window||void 0===window?void 0:window.navigator)||void 0===e?void 0:e.mediaDevices)||void 0===t?void 0:t.enumerateDevices))throw new Error("Failed to access the camera because the browser is too old or the page is loaded from an insecure origin.");const i=(await navigator.mediaDevices.enumerateDevices()).filter((e=>"videoinput"===e.kind));return i&&i.length&&!i[0].deviceId?this._getCameras(!0):this._getCameras(!1)}async getAllCameras(){return this.getCameras()}async setResolution(e,i,a){if("number"!=typeof e||e<=0)throw new TypeError("Invalid 'width'.");if("number"!=typeof i||i<=0)throw new TypeError("Invalid 'height'.");if("object"!=typeof t(this,M,"f").video&&(t(this,M,"f").video={}),a?(t(this,M,"f").video.width={exact:e},t(this,M,"f").video.height={exact:i}):(t(this,M,"f").video.width={ideal:e},t(this,M,"f").video.height={ideal:i}),"closed"===this.state||this.videoSrc||"opening"===this.state&&t(this,D,"f"))return null;t(this,z,"f").fire("before:resolution:change",[],{target:this,async:!1}),await t(this,P,"m",re).call(this);try{this.resetSoftwareScale()}catch(e){}const r=this.getResolution();return{width:r.width,height:r.height}}getResolution(){if("opened"===this.state&&this.videoSrc&&t(this,S,"f"))return{width:t(this,S,"f").videoWidth,height:t(this,S,"f").videoHeight};if(t(this,L,"f")){const e=t(this,L,"f").getSettings();return{width:e.width,height:e.height}}if(this.isVideoLoaded())return{width:t(this,S,"f").videoWidth,height:t(this,S,"f").videoHeight};{const e={width:0,height:0};let i=t(this,M,"f").video.width||0,a=t(this,M,"f").video.height||0;return i&&(e.width=i.exact||i.ideal||i),a&&(e.height=a.exact||a.ideal||a),e}}async getResolutions(e){var a,r,s,o,n,h,l,d,c,f,u;if(!(null===(r=null===(a=null===window||void 0===window?void 0:window.navigator)||void 0===a?void 0:a.mediaDevices)||void 0===r?void 0:r.getUserMedia))throw new Error("Failed to access the camera because the browser is too old or the page is loaded from an insecure origin.");let m="";const w=(e,i)=>{const a=t(this,$,"f").get(e);if(!a||!a.length)return!1;for(let e of a)if(e.width===i.width&&e.height===i.height)return!0;return!1};if(this._mediaStream){m=null===(u=t(this,W,"f"))||void 0===u?void 0:u.deviceId;let a=t(this,$,"f").get(m);if(a&&!e)return JSON.parse(JSON.stringify(a));a=[],t(this,$,"f").set(m,a),i(this,U,!0,"f");try{for(let e of this.detectedResolutions){await t(this,L,"f").applyConstraints({width:{ideal:e.width},height:{ideal:e.height}}),t(this,P,"m",ee).call(this);const i=t(this,L,"f").getSettings(),r={width:i.width,height:i.height};w(m,r)||a.push({width:r.width,height:r.height})}}catch(e){throw t(this,P,"m",se).call(this),i(this,U,!1,"f"),e}try{await t(this,P,"m",ae).call(this)}catch(e){if("AbortError"===e.name)return a;throw e}finally{i(this,U,!1,"f")}return a}{const i=async(e,t,i)=>{const a={video:{deviceId:{exact:e},width:{ideal:t},height:{ideal:i}}};let r=null;try{r=await navigator.mediaDevices.getUserMedia(a)}catch(e){return null}if(!r)return null;const s=r.getVideoTracks();let o=null;try{const e=s[0].getSettings();o={width:e.width,height:e.height}}catch(e){const t=document.createElement("video");t.srcObject=r,o={width:t.videoWidth,height:t.videoHeight},t.srcObject=null}return s.forEach((e=>{e.stop()})),o};let a=(null===(n=null===(o=null===(s=t(this,M,"f"))||void 0===s?void 0:s.video)||void 0===o?void 0:o.deviceId)||void 0===n?void 0:n.exact)||(null===(d=null===(l=null===(h=t(this,M,"f"))||void 0===h?void 0:h.video)||void 0===l?void 0:l.deviceId)||void 0===d?void 0:d.ideal)||(null===(f=null===(c=t(this,M,"f"))||void 0===c?void 0:c.video)||void 0===f?void 0:f.deviceId);if(!a)return[];let r=t(this,$,"f").get(a);if(r&&!e)return JSON.parse(JSON.stringify(r));r=[],t(this,$,"f").set(a,r);for(let e of this.detectedResolutions){const t=await i(a,e.width,e.height);t&&!w(a,t)&&r.push({width:t.width,height:t.height})}return r}}async setMediaStreamConstraints(e,a){if(!b(e))throw new TypeError("Invalid 'mediaStreamConstraints'.");i(this,M,JSON.parse(JSON.stringify(e)),"f"),i(this,k,null,"f"),a&&t(this,P,"m",re).call(this)}getMediaStreamConstraints(){return JSON.parse(JSON.stringify(t(this,M,"f")))}resetMediaStreamConstraints(){i(this,M,this.defaultConstraints?JSON.parse(JSON.stringify(this.defaultConstraints)):null,"f")}getCameraCapabilities(){if(!t(this,L,"f")||"opened"!==this.state)throw new Error("Camera is not open.");return t(this,L,"f").getCapabilities?t(this,L,"f").getCapabilities():{}}getCameraSettings(){if(!t(this,L,"f")||"opened"!==this.state)throw new Error("Camera is not open.");return t(this,L,"f").getSettings()}async turnOnTorch(){if(!t(this,L,"f")||"opened"!==this.state)throw new Error("Camera is not open.");const e=this.getCameraCapabilities();if(!(null==e?void 0:e.torch))throw Error("Not supported.");await t(this,L,"f").applyConstraints({advanced:[{torch:!0}]})}async turnOffTorch(){if(!t(this,L,"f")||"opened"!==this.state)throw new Error("Camera is not open.");const e=this.getCameraCapabilities();if(!(null==e?void 0:e.torch))throw Error("Not supported.");await t(this,L,"f").applyConstraints({advanced:[{torch:!1}]})}async setColorTemperature(e,i){var a;if("number"!=typeof e)throw new TypeError("Invalid 'value'.");if(!t(this,L,"f")||"opened"!==this.state)throw new Error("Camera is not open.");const r=null===(a=this.getCameraCapabilities())||void 0===a?void 0:a.colorTemperature;if(!r)throw Error("Not supported.");return i&&(e<r.min?e=r.min:e>r.max&&(e=r.max),e=fe(e,r.min,r.step,r.max)),await t(this,L,"f").applyConstraints({advanced:[{colorTemperature:e,whiteBalanceMode:"manual"}]}),e}getColorTemperature(){return this.getCameraSettings().colorTemperature||0}async setExposureCompensation(e,i){var a;if("number"!=typeof e)throw new TypeError("Invalid 'value'.");if(!t(this,L,"f")||"opened"!==this.state)throw new Error("Camera is not open.");const r=null===(a=this.getCameraCapabilities())||void 0===a?void 0:a.exposureCompensation;if(!r)throw Error("Not supported.");return i&&(e<r.min?e=r.min:e>r.max&&(e=r.max),e=fe(e,r.min,r.step,r.max)),await t(this,L,"f").applyConstraints({advanced:[{exposureCompensation:e}]}),e}getExposureCompensation(){return this.getCameraSettings().exposureCompensation||0}async setFrameRate(e,i){var a;if("number"!=typeof e)throw new TypeError("Invalid 'value'.");if(!t(this,L,"f")||"opened"!==this.state)throw new Error("Camera is not open.");let r=null===(a=this.getCameraCapabilities())||void 0===a?void 0:a.frameRate;if(!r)throw Error("Not supported.");i&&(e<r.min?e=r.min:e>r.max&&(e=r.max));const s=this.getResolution();return await t(this,L,"f").applyConstraints({width:{ideal:Math.max(s.width,s.height)},frameRate:e}),e}getFrameRate(){return this.getCameraSettings().frameRate}async setFocus(e,i){if("object"!=typeof e||Array.isArray(e)||null==e)throw new TypeError("Invalid 'settings'.");if(!t(this,L,"f")||"opened"!==this.state)throw new Error("Camera is not open.");const a=this.getCameraCapabilities(),r=null==a?void 0:a.focusMode,s=null==a?void 0:a.focusDistance;if(!r)throw Error("Not supported.");if("string"!=typeof e.mode)throw TypeError("Invalid 'mode'.");const o=e.mode.toLowerCase();if(!r.includes(o))throw Error("Unsupported focus mode.");if("manual"===o){if(!s)throw Error("Manual focus unsupported.");if(e.hasOwnProperty("distance")){let a=e.distance;i&&(a<s.min?a=s.min:a>s.max&&(a=s.max),a=fe(a,s.min,s.step,s.max)),this._focusParameters.focusArea=null,await t(this,L,"f").applyConstraints({advanced:[{focusMode:o,focusDistance:a}]})}else{if(!e.area)throw new Error("'distance' or 'area' should be specified in 'manual' mode.");{const i=e.area.centerPoint;let a=e.area.width,r=e.area.height;if(!a||!r){const e=this.getResolution();a||(a=2*Math.round(Math.min(e.width,e.height)/this._focusParameters.defaultFocusAreaSizeRatio/2)+"px"),r||(r=2*Math.round(Math.min(e.width,e.height)/this._focusParameters.defaultFocusAreaSizeRatio/2)+"px")}this._focusParameters.focusArea={centerPoint:{x:i.x,y:i.y},width:a,height:r},await t(this,P,"m",he).call(this,i,a,r)}}}else this._focusParameters.focusArea=null,await t(this,L,"f").applyConstraints({advanced:[{focusMode:o}]})}getFocus(){const e=this.getCameraSettings(),t=e.focusMode;return t?"manual"===t?this._focusParameters.focusArea?{mode:"manual",area:JSON.parse(JSON.stringify(this._focusParameters.focusArea))}:{mode:"manual",distance:e.focusDistance}:{mode:t}:null}async enableTapToFocus(){i(this,O,!0,"f")}disableTapToFocus(){i(this,O,!1,"f")}isTapToFocusEnabled(){return t(this,O,"f")}async setZoom(e){if("object"!=typeof e||Array.isArray(e)||null==e)throw new TypeError("Invalid 'settings'.");if("number"!=typeof e.factor)throw new TypeError("Illegal type of 'factor'.");if(e.factor<1)throw new RangeError("Invalid 'factor'.");if("opened"!==this.state)throw new Error("Video is not playing.");e.centerPoint?t(this,P,"m",le).call(this,e.centerPoint):this.resetScaleCenter();try{if(t(this,P,"m",de).call(this,t(this,Y,"f"))){const t=await this.setHardwareScale(e.factor,!0);let i=this.getHardwareScale();1==i&&1!=t&&(i=t),e.factor>i?this.setSoftwareScale(e.factor/i):this.setSoftwareScale(1)}else await this.setHardwareScale(1),this.setSoftwareScale(e.factor)}catch(t){const i=t.message||t;if("Not supported."!==i&&"Camera is not open."!==i)throw t;this.setSoftwareScale(e.factor)}}getZoom(){if("opened"!==this.state)throw new Error("Video is not playing.");let e=1;try{e=this.getHardwareScale()}catch(e){if("Camera is not open."!==(e.message||e))throw e}return{factor:e*t(this,j,"f")}}async resetZoom(){await this.setZoom({factor:1})}async setHardwareScale(e,i){var a;if("number"!=typeof e)throw new TypeError("Invalid 'value'.");if(e<1)throw new RangeError("Invalid 'value'.");if(!t(this,L,"f")||"opened"!==this.state)throw new Error("Camera is not open.");const r=null===(a=this.getCameraCapabilities())||void 0===a?void 0:a.zoom;if(!r)throw Error("Not supported.");return i&&(e<r.min?e=r.min:e>r.max&&(e=r.max),e=fe(e,r.min,r.step,r.max)),await t(this,L,"f").applyConstraints({advanced:[{zoom:e}]}),e}getHardwareScale(){return this.getCameraSettings().zoom||1}setSoftwareScale(e,a){if("number"!=typeof e)throw new TypeError("Invalid 'value'.");if(e<1)throw new RangeError("Invalid 'value'.");if("opened"!==this.state)throw new Error("Video is not playing.");a&&t(this,P,"m",le).call(this,a),i(this,j,e,"f"),this.updateVideoElWhenSoftwareScaled()}getSoftwareScale(){return t(this,j,"f")}resetScaleCenter(){if("opened"!==this.state)throw new Error("Video is not playing.");const e=this.getResolution();i(this,Y,{x:e.width/2,y:e.height/2},"f")}resetSoftwareScale(){this.setSoftwareScale(1),this.resetScaleCenter()}getFrameData(i){if(this.disposed)throw Error("The 'Camera' instance has been disposed.");if(!this.isVideoLoaded())return null;if(t(this,U,"f"))return null;const a=Date.now();ue._onLog&&ue._onLog("getFrameData() START: "+a);const r=t(this,S,"f").videoWidth,s=t(this,S,"f").videoHeight;let o={sx:0,sy:0,sWidth:r,sHeight:s,dWidth:r,dHeight:s};(null==i?void 0:i.position)&&(o=JSON.parse(JSON.stringify(i.position)));let n=e.EnumPixelFormat.RGBA;(null==i?void 0:i.pixelFormat)&&(n=i.pixelFormat);let h=t(this,j,"f");(null==i?void 0:i.scale)&&(h=i.scale);let l=t(this,Y,"f");if(null==i?void 0:i.scaleCenter){if("string"!=typeof i.scaleCenter.x||"string"!=typeof i.scaleCenter.y)throw new Error("Invalid scale center.");let e=0,t=0;if(i.scaleCenter.x.endsWith("px"))e=parseFloat(i.scaleCenter.x);else{if(!i.scaleCenter.x.endsWith("%"))throw new Error("Invalid scale center.");e=parseFloat(i.scaleCenter.x)/100*r}if(i.scaleCenter.y.endsWith("px"))t=parseFloat(i.scaleCenter.y);else{if(!i.scaleCenter.y.endsWith("%"))throw new Error("Invalid scale center.");t=parseFloat(i.scaleCenter.y)/100*s}if(isNaN(e)||isNaN(t))throw new Error("Invalid scale center.");l.x=Math.round(e),l.y=Math.round(t)}let d=null;if((null==i?void 0:i.bufferContainer)&&(d=i.bufferContainer),0==r||0==s)return null;1!==h&&(o.sWidth=Math.round(o.sWidth/h),o.sHeight=Math.round(o.sHeight/h),o.sx=Math.round((1-1/h)*l.x+o.sx/h),o.sy=Math.round((1-1/h)*l.y+o.sy/h));const c=this.imageDataGetter.getImageData(t(this,S,"f"),r,s,o,{pixelFormat:n,bufferContainer:d});if(!c)return null;const f=Date.now();return ue._onLog&&ue._onLog("getFrameData() END: "+f),{data:c.data,width:c.width,height:c.height,pixelFormat:c.pixelFormat,timeSpent:f-a,timeStamp:f,toCanvas:t(this,J,"f")}}on(e,i){if(!t(this,X,"f").includes(e.toLowerCase()))throw new Error(`Event '${e}' does not exist.`);t(this,z,"f").on(e,i)}off(e,i){t(this,z,"f").off(e,i)}async dispose(){this.tapFocusEventBoundEl=null,await this.close(),this.releaseVideoEl(),t(this,z,"f").dispose(),this.imageDataGetter.dispose(),document.removeEventListener("visibilitychange",t(this,Z,"f")),i(this,Q,!0,"f")}}S=new WeakMap,L=new WeakMap,T=new WeakMap,I=new WeakMap,M=new WeakMap,W=new WeakMap,k=new WeakMap,F=new WeakMap,R=new WeakMap,D=new WeakMap,A=new WeakMap,G=new WeakMap,U=new WeakMap,O=new WeakMap,B=new WeakMap,N=new WeakMap,H=new WeakMap,V=new WeakMap,j=new WeakMap,Y=new WeakMap,J=new WeakMap,z=new WeakMap,X=new WeakMap,$=new WeakMap,q=new WeakMap,Z=new WeakMap,Q=new WeakMap,P=new WeakSet,K=async function(){const e=this.getMediaStreamConstraints();if("boolean"==typeof e.video&&(e.video={}),e.video.deviceId);else if(t(this,k,"f"))delete e.video.facingMode,e.video.deviceId={exact:t(this,k,"f")};else if(this.ifSaveLastUsedCamera&&ue.isStorageAvailable&&window.localStorage.getItem("dce_last_camera_id")){delete e.video.facingMode,e.video.deviceId={ideal:window.localStorage.getItem("dce_last_camera_id")};const t=JSON.parse(window.localStorage.getItem("dce_last_apply_width")),i=JSON.parse(window.localStorage.getItem("dce_last_apply_height"));t&&i&&(e.video.width=t,e.video.height=i)}else if(this.ifSkipCameraInspection);else{const i=async e=>{let i=null;return"environment"===e&&["Android","HarmonyOS","iPhone","iPad"].includes(h.OS)?(await this._getCameras(!1),t(this,P,"m",ee).call(this),i=ue.findBestCamera(this._arrCameras,"environment",{getMainCameraInIOS:this.selectIOSRearMainCameraAsDefault})):e||["Android","HarmonyOS","iPhone","iPad"].includes(h.OS)||(await this._getCameras(!1),t(this,P,"m",ee).call(this),i=ue.findBestCamera(this._arrCameras,null,{getMainCameraInIOS:this.selectIOSRearMainCameraAsDefault})),i};let a=e.video.facingMode;a instanceof Array&&a.length&&(a=a[0]),"object"==typeof a&&(a=a.exact||a.ideal);const r=await i(a);r&&(delete e.video.facingMode,e.video.deviceId={exact:r})}return e},ee=function(){if(t(this,D,"f")){const e=new Error("The operation was interrupted.");throw e.name="AbortError",e}},te=async function(e){var i,a;if(!(null===(a=null===(i=null===window||void 0===window?void 0:window.navigator)||void 0===i?void 0:i.mediaDevices)||void 0===a?void 0:a.getUserMedia))throw new Error("Failed to access the camera because the browser is too old or the page is loaded from an insecure origin.");let r;try{ue._onLog&&ue._onLog("======try getUserMedia========");let i=[0,500,1e3,2e3],a=null;const s=async e=>{for(let s of i){s&&(await new Promise((e=>setTimeout(e,s))),t(this,P,"m",ee).call(this));try{ue._onLog&&ue._onLog("ask "+JSON.stringify(e)),r=await navigator.mediaDevices.getUserMedia(e),t(this,P,"m",ee).call(this);break}catch(e){if("NotFoundError"===e.name||"NotAllowedError"===e.name||"AbortError"===e.name||"OverconstrainedError"===e.name)throw e;a=e,ue._onLog&&ue._onLog(e.message||e)}}};if(await s(e),r||"object"!=typeof e.video||(e.video.deviceId&&(delete e.video.deviceId,await s(e)),!r&&e.video.facingMode&&(delete e.video.facingMode,await s(e)),r||!e.video.width&&!e.video.height||(delete e.video.width,delete e.video.height,await s(e))),!r)throw a;return r}catch(e){throw null==r||r.getTracks().forEach((e=>{e.stop()})),"NotFoundError"===e.name&&(DOMException?e=new DOMException("No camera available, please use a device with an accessible camera.",e.name):(e=new Error("No camera available, please use a device with an accessible camera.")).name="NotFoundError"),e}},ie=function(){this._mediaStream&&(this._mediaStream.getTracks().forEach((e=>{e.stop()})),this._mediaStream=null),i(this,L,null,"f")},ae=async function(){i(this,D,!1,"f");const e=i(this,R,Symbol(),"f");if(t(this,A,"f")&&"pending"===t(this,G,"f")){try{await t(this,A,"f")}catch(e){}t(this,P,"m",ee).call(this)}if(e!==t(this,R,"f"))return;const a=i(this,A,(async()=>{i(this,G,"pending","f");try{if(this.videoSrc){if(!t(this,S,"f"))throw new Error("'videoEl' should be set.");await ue.playVideo(t(this,S,"f"),this.videoSrc,this.cameraOpenTimeout),t(this,P,"m",ee).call(this)}else{let e=await t(this,P,"m",K).call(this);t(this,P,"m",ie).call(this);let a=await t(this,P,"m",te).call(this,e);await this._getCameras(!1),t(this,P,"m",ee).call(this);const r=()=>{const e=a.getVideoTracks();let t,i;if(e.length&&(t=e[0]),t){const e=t.getSettings();if(e)for(let a of this._arrCameras)if(e.deviceId===a.deviceId){a._checked=!0,a.label=t.label,i=a;break}}return i},s=t(this,M,"f");if("object"==typeof s.video){let i=s.video.facingMode;if(i instanceof Array&&i.length&&(i=i[0]),"object"==typeof i&&(i=i.exact||i.ideal),!(t(this,k,"f")||this.ifSaveLastUsedCamera&&ue.isStorageAvailable&&window.localStorage.getItem("dce_last_camera_id")||this.ifSkipCameraInspection||s.video.deviceId)){const s=r(),o=ue.findBestCamera(this._arrCameras,i,{getMainCameraInIOS:this.selectIOSRearMainCameraAsDefault});o&&o!=(null==s?void 0:s.deviceId)&&(a.getTracks().forEach((e=>{e.stop()})),e.video.deviceId={exact:o},a=await t(this,P,"m",te).call(this,e),t(this,P,"m",ee).call(this))}}const o=r();(null==o?void 0:o.deviceId)&&(i(this,k,o&&o.deviceId,"f"),this.ifSaveLastUsedCamera&&ue.isStorageAvailable&&(window.localStorage.setItem("dce_last_camera_id",t(this,k,"f")),"object"==typeof e.video&&e.video.width&&e.video.height&&(window.localStorage.setItem("dce_last_apply_width",JSON.stringify(e.video.width)),window.localStorage.setItem("dce_last_apply_height",JSON.stringify(e.video.height))))),t(this,S,"f")&&(await ue.playVideo(t(this,S,"f"),a,this.cameraOpenTimeout),t(this,P,"m",ee).call(this)),this._mediaStream=a;const n=a.getVideoTracks();(null==n?void 0:n.length)&&i(this,L,n[0],"f"),i(this,W,o,"f")}}catch(e){throw t(this,P,"m",se).call(this),i(this,G,null,"f"),e}i(this,G,"fulfilled","f")})(),"f");return a},re=async function(){var e;if("closed"===this.state||this.videoSrc)return;const i=null===(e=t(this,W,"f"))||void 0===e?void 0:e.deviceId,a=this.getResolution();await t(this,P,"m",ae).call(this);const r=this.getResolution();i&&i!==t(this,W,"f").deviceId&&t(this,z,"f").fire("camera:changed",[t(this,W,"f").deviceId,i],{target:this,async:!0}),a.width==r.width&&a.height==r.height||t(this,z,"f").fire("resolution:changed",[{width:r.width,height:r.height},{width:a.width,height:a.height}],{target:this,async:!0}),t(this,z,"f").fire("played",null,{target:this,async:!0})},se=function(){t(this,P,"m",ie).call(this),i(this,W,null,"f"),t(this,S,"f")&&(t(this,S,"f").srcObject=null,this.videoSrc&&(t(this,S,"f").pause(),t(this,S,"f").currentTime=0)),i(this,D,!0,"f");try{this.resetSoftwareScale()}catch(e){}},oe=async function i(a,r){const s=e=>{if(!t(this,L,"f")||!this.isVideoPlaying||e.focusTaskId!=this._focusParameters.curFocusTaskId){t(this,L,"f")&&this.isVideoPlaying||(this._focusParameters.isDoingFocus=0);const i=new Error(`Focus task ${e.focusTaskId} canceled.`);throw i.name="DeprecatedTaskError",i}1===this._focusParameters.isDoingFocus&&Date.now()-e.timeStart>this._focusParameters.focusCancelableTime&&(this._focusParameters.isDoingFocus=-1)};let o;r=fe(r,this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),await t(this,L,"f").applyConstraints({advanced:[{focusMode:"manual",focusDistance:r}]}),s(a),o=null==this._focusParameters.oldDistance?this._focusParameters.kTimeout*Math.max(Math.abs(1/this._focusParameters.fds.min-1/r),Math.abs(1/this._focusParameters.fds.max-1/r))+this._focusParameters.minTimeout:this._focusParameters.kTimeout*Math.abs(1/this._focusParameters.oldDistance-1/r)+this._focusParameters.minTimeout,this._focusParameters.oldDistance=r,await new Promise((e=>{setTimeout(e,o)})),s(a);let n=a.focusL-a.focusW/2,h=a.focusT-a.focusH/2,l=a.focusW,d=a.focusH;const c=this.getResolution();if(n>=c.width||h>=c.height)throw new Error("Invalid area.");n+l>c.width&&(l=c.width-n),h+d>c.height&&(d=c.height-h),n=Math.round(n),h=Math.round(h),l=Math.round(l),d=Math.round(d);const f=4*c.width*c.height*this._focusParameters.defaultTempBufferContainerLenRatio,u=4*l*d;let m=this._focusParameters.tempBufferContainer;if(m){const e=m.length;f>e&&f>=u?m=new Uint8Array(f):u>e&&u>=f&&(m=new Uint8Array(u))}else m=this._focusParameters.tempBufferContainer=new Uint8Array(Math.max(f,u));if(!this.imageDataGetter.getImageData(t(this,S,"f"),c.width,c.height,{sx:n,sy:h,sWidth:l,sHeight:d,dWidth:l,dHeight:d},{pixelFormat:e.EnumPixelFormat.RGBA,bufferContainer:m}))return t(this,P,"m",i).call(this,a,r);const w=m;let g=0;for(let e=0,t=u-8;e<t;++e){let t=w[e]-w[e+8];++e;let i=w[e]-w[e+8];++e;let a=w[e]-w[e+8];++e,g+=t*t+i*i+a*a}return-g},ne=async function e(i,a,r,s,o,n,h){let l;if(a=fe(a,this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),s=fe(s,this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),n?n=fe(n,this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max):(n=fe(Math.sqrt((a||this._focusParameters.fds.step)*(s||this._focusParameters.fds.step)),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),h=await t(this,P,"m",oe).call(this,i,n)),h<=r&&h<=o?l=3:r<o&&r<h?l=1:o<r&&o<h&&(l=2),(s-a)/2<=this._focusParameters.fds.step)return 3===l||(1===l?await t(this,L,"f").applyConstraints({advanced:[{focusMode:"manual",focusDistance:a}]}):2===l&&await t(this,L,"f").applyConstraints({advanced:[{focusMode:"manual",focusDistance:s}]})),!0;if(1===l)return await t(this,P,"m",e).call(this,i,a,r,n,h);if(2===l)return await t(this,P,"m",e).call(this,i,n,h,s,o);if(3!==l)return r=await t(this,P,"m",oe).call(this,i,a),o=await t(this,P,"m",oe).call(this,i,s),await t(this,P,"m",e).call(this,i,a,r,s,o);let d=fe(Math.sqrt((a||this._focusParameters.fds.step)*(n||this._focusParameters.fds.step)),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),c=fe(Math.sqrt((s||this._focusParameters.fds.step)*(n||this._focusParameters.fds.step)),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max);if(Math.abs(1/this._focusParameters.oldDistance-1/d)<=Math.abs(1/this._focusParameters.oldDistance-1/c)){let l=await t(this,P,"m",oe).call(this,i,d);if(l<h)return await t(this,P,"m",e).call(this,i,a,r,n,h,d,l);if(l==h)return await t(this,P,"m",e).call(this,i,d,l,n,h);let f=await t(this,P,"m",oe).call(this,i,c);if(l>h&&h<f)return await t(this,P,"m",e).call(this,i,d,l,c,f,n,h);if(h==f)return await t(this,P,"m",e).call(this,i,n,h,c,f);if(h>f)return await t(this,P,"m",e).call(this,i,n,h,s,o,c,f)}else{let l=await t(this,P,"m",oe).call(this,i,c);if(h>l)return await t(this,P,"m",e).call(this,i,n,h,s,o,c,l);if(h==l)return await t(this,P,"m",e).call(this,i,n,h,c,l);let f=await t(this,P,"m",oe).call(this,i,d);if(f>h&&h<l)return await t(this,P,"m",e).call(this,i,d,f,c,l,n,h);if(f==h)return await t(this,P,"m",e).call(this,i,d,f,n,h);if(f<h)return await t(this,P,"m",e).call(this,i,a,r,n,h,d,f)}return!1},he=async function(e,i,a,r,s){var o;if(1==this._focusParameters.isDoingFocus)return!1;if(!e||"string"!=typeof e.x||"string"!=typeof e.y)throw new Error("Invalid 'centerPoint'.");if(!i||"string"!=typeof i)throw new Error("Invalid 'width'.");if(!a||"string"!=typeof a)throw new Error("Invalid 'height'.");const n=this.getResolution();let h=0,l=0;if(e.x.endsWith("px"))h=parseFloat(e.x);else{if(!e.x.endsWith("%"))throw new Error("Invalid 'centerPoint'.");h=parseFloat(e.x)/100*n.width}if(e.y.endsWith("px"))l=parseFloat(e.y);else{if(!e.y.endsWith("%"))throw new Error("Invalid 'centerPoint'.");l=parseFloat(e.y)/100*n.height}if(isNaN(h)||isNaN(l)||h<0||h>n.width||l<0||l>n.height)throw new Error("Invalid 'centerPoint'.");let d=0;if(i.endsWith("px"))d=parseFloat(i);else{if(!i.endsWith("%"))throw new Error("Invalid 'width'.");d=parseFloat(i)/100*n.width}if(isNaN(d)||d<0)throw new Error("Invalid 'width'.");let c=0;if(a.endsWith("px"))c=parseFloat(a);else{if(!a.endsWith("%"))throw new Error("Invalid 'height'.");c=parseFloat(a)/100*n.height}if(isNaN(c)||c<0)throw new Error("Invalid 'height'.");if(1!==t(this,j,"f")){const e=t(this,j,"f"),i=t(this,Y,"f");d/=e,c/=e,h=(1-1/e)*i.x+h/e,l=(1-1/e)*i.y+l/e}if(!this._focusSupported)throw new Error("Manual focus unsupported.");if(!this._focusParameters.fds&&(this._focusParameters.fds=null===(o=this.getCameraCapabilities())||void 0===o?void 0:o.focusDistance,!this._focusParameters.fds))throw this._focusSupported=!1,new Error("Manual focus unsupported.");null==this._focusParameters.kTimeout&&(this._focusParameters.kTimeout=(this._focusParameters.maxTimeout-this._focusParameters.minTimeout)/(1/this._focusParameters.fds.min-1/this._focusParameters.fds.max)),this._focusParameters.isDoingFocus=1;const f={focusL:h,focusT:l,focusW:d,focusH:c,focusTaskId:++this._focusParameters.curFocusTaskId,timeStart:Date.now()},u=async(e,i,a)=>{try{(null==i||i<this._focusParameters.fds.min)&&(i=this._focusParameters.fds.min),(null==a||a>this._focusParameters.fds.max)&&(a=this._focusParameters.fds.max),this._focusParameters.oldDistance=null;let r=fe(Math.sqrt(a*(i||this._focusParameters.fds.step)),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),s=fe(Math.sqrt((i||this._focusParameters.fds.step)*r),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),o=fe(Math.sqrt(r*a),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),n=await t(this,P,"m",oe).call(this,e,o),h=await t(this,P,"m",oe).call(this,e,s),l=await t(this,P,"m",oe).call(this,e,r);if(h>l&&l<n){const i=await t(this,P,"m",ne).call(this,e,s,h,o,n,r,l);return this._focusParameters.isDoingFocus=0,i}if(h<l&&h<n){let a=await t(this,P,"m",oe).call(this,e,i);const o=await t(this,P,"m",ne).call(this,e,i,a,r,l,s,h);return this._focusParameters.isDoingFocus=0,o}if(l>n&&h>n){let i=await t(this,P,"m",oe).call(this,e,a);const s=await t(this,P,"m",ne).call(this,e,r,l,a,i,o,n);return this._focusParameters.isDoingFocus=0,s}if(h==l&&l<n){const i=await t(this,P,"m",ne).call(this,e,s,h,r,l);return this._focusParameters.isDoingFocus=0,i}if(l==n&&h>l){const i=await t(this,P,"m",ne).call(this,e,r,l,o,n);return this._focusParameters.isDoingFocus=0,i}return u(e,i,a)}catch(e){if("DeprecatedTaskError"!==e.name)throw e}};return u(f,r,s)},le=function(e){if("opened"!==this.state)throw new Error("Video is not playing.");if(!e||"string"!=typeof e.x||"string"!=typeof e.y)throw new Error("Invalid 'center'.");const t=this.getResolution();let a=0,r=0;if(e.x.endsWith("px"))a=parseFloat(e.x);else{if(!e.x.endsWith("%"))throw new Error("Invalid scale center.");a=parseFloat(e.x)/100*t.width}if(e.y.endsWith("px"))r=parseFloat(e.y);else{if(!e.y.endsWith("%"))throw new Error("Invalid scale center.");r=parseFloat(e.y)/100*t.height}if(isNaN(a)||isNaN(r))throw new Error("Invalid scale center.");i(this,Y,{x:a,y:r},"f")},de=function(e){if("opened"!==this.state)throw new Error("Video is not playing.");const t=this.getResolution();return e&&e.x==t.width/2&&e.y==t.height/2},ue.browserInfo=h,ue.onWarning=null===(C=null===window||void 0===window?void 0:window.console)||void 0===C?void 0:C.warn,e.CameraManager=ue,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=index.js.map
