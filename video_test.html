<!DOCTYPE html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>test</title>
  <script src="https://cdn.jsdelivr.net/npm/dynamsoft-javascript-barcode@8.8.3/dist/dbr.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/eruda@2.4.1/eruda.min.js"></script>
  <!-- <script type="text/javascript" src="../js/common.js"></script> -->
</head>
<body>
  <script>
    Dynamsoft.DBR.organizationID = "100728239";
    eruda.init();
    var ws=null,wo=null;
    var scan=null,domready=false,bCancel=false;
    let pScanner = null;
    function plusReady(){
    	if(ws||!window.plus||!domready){
    		return;
    	}
    	// 获取窗口对象
    	ws=plus.webview.currentWebview();
    	wo=ws.opener();
    	mainS();
    }
	if(window.plus){
		console.log("123");
		plusReady();
	}else{
		console.log("456");
		document.addEventListener('plusready', plusReady, false);
	}
	// 监听DOMContentLoaded事件
	document.addEventListener('DOMContentLoaded', function(){
		domready=true;
		plusReady();
	}, false);
    (async function mainS(){

      let scanner = await Dynamsoft.DBR.BarcodeScanner.createInstance();
      var count = 0;
      scanner.onFrameRead = results => {
        if (results.length > 0) console.log(results);
      };
      scanner.onUnduplicatedRead = (txt, result) => {
        // wo.evalJS("scanedbyvideo('"+ txt +"','"+ count +"');");
        count++;
        back();
		    //alert(txt);
      };
      
      let bFirst = true;
      let bestDevice = localStorage.getItem('dynamsoft-bestDevice');
      let _old_getAllCameras;


      if(bestDevice){
        // 2rd time will enter here
        console.log(`it's 2rd time, best DeviceId is ${bestDevice}`)
        _old_getAllCameras = scanner.dce.getAllCameras
        scanner.dce.getAllCameras = ()=>{
          const devices = [{deviceId: bestDevice ,label:'camera2 0, facing back',_checked:true}];
          scanner.dce._allCameras = devices;
          return devices;
        };
        scanner.dce.updateVideoSettings({
          video:{
            width:{ideal:1280},
            height:{ideal:720},
            deviceId: bestDevice
          }
        });
        bFirst = false;
      } else{
        console.log(`it's 1st time`)
      }

      let beginTime = Date.now()
      await scanner.show();
      console.log((Date.now() - beginTime) + 'ms');

      // save best device into localStorage
      bestDevice = scanner.dce._lastDeviceId;
      if(bestDevice){
        localStorage.setItem('dynamsoft-bestDevice',bestDevice);
        console.log(`bestDevice ${bestDevice} had saved.`)
      }

      if(!bFirst){
        scanner.dce.getAllCameras = _old_getAllCameras;
        await scanner.dce.getAllCameras();
        scanner.dce._renderSelCameraInfo();
      }
    })()
  </script>
</body>
</html>