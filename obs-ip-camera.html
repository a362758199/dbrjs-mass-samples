<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  <button id="btn-scan">scan</button><br>
  test image: <input id="ipt-file" type="file">
  <script src="https://cdn.jsdelivr.net/npm/dynamsoft-barcode-reader-bundle@10.2.1000/dist/dbr.bundle.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/Dynamsoft/easy-barcode-scanner@10.2.1009/dist/easy-barcode-scanner.js"
    data-license=""></script>
  <script>
    // refer https://github.com/Dynamsoft/easy-barcode-scanner
    let scanner, pScanner;

    document.getElementById('btn-scan').addEventListener('click',async()=>{
      try{
        scanner = await (pScanner || (pScanner = EasyBarcodeScanner.createInstance()));
        updateBarcodeSettings();

        // pls match OBS output resolution
        // { width: 1920, height: 1080 }
        // { width: 2560, height: 1440 }
        // don't change media source size
        // right click media source -> transform -> reset transform
        scanner._cameraEnhancer.setResolution({ width: 1920, height: 1080 });

        scanner.onUniqueRead = txt=>console.log(txt);

        await scanner.open();
      }catch(ex){
        let errMsg = ex.message || ex;
        console.error(errMsg);
        alert(errMsg);
      }
    });
    
    document.getElementById('ipt-file').addEventListener('change',async function(){
      scanner = await (pScanner || (pScanner = EasyBarcodeScanner.createInstance()));
      updateBarcodeSettings();

      let file = this.files[0];
      this.value = '';
      let rs = await scanner._cvRouter.capture(file,scanner.templateName);
      console.log(rs);
    });


    // TODO: https://www.dynamsoft.com/capture-vision/docs/core/parameters/reference/image-parameter/binarization-modes.html?product=dbr
    function updateBarcodeSettings(){
        scanner._cvRouter.initSettings(`{
            "BarcodeReaderTaskSettingOptions": [
                {
                    "BarcodeFormatIds": [
                        "BF_QR_CODE"
                    ],
                    "DeblurModes": [
                        {
                            "Mode": "DM_BASED_ON_LOC_BIN"
                        },
                        {
                            "Mode": "DM_SMOOTHING"
                        }
                    ],
                    "ExpectedBarcodesCount": 999,
                    "LocalizationModes": [
                        {
                            "Mode": "LM_CONNECTED_BLOCKS"
                        }
                    ],
                    "Name": "task-read-barcodes",
                    "StartSection": "ST_REGION_PREDETECTION",
                    "TerminateSetting": {
                        "Section": "ST_NULL",
                        "Stage": "IRUT_NULL"
                    }
                }
            ],
            "CaptureVisionTemplates": [
                {
                    "ImageROIProcessingNameArray": [
                        "roi-read-barcodes"
                    ],
                    "Name": "ReadBarcodes_Default"
                }
            ],
            "ImageParameterOptions": [
                {
                    "BinarizationModes": [
                        {
                            "Mode": "BM_LOCAL_BLOCK",
                            "BinarizationThreshold": -1,
                            "BlockSizeX": 39,
                            "BlockSizeY": 39,
                            "EnableFillBinaryVacancy": 0,
                            "ThresholdCompensation": 10
                        }
                    ],
                    "GrayscaleTransformationModes": [
                        {
                            "Mode": "GTM_ORIGINAL"
                        }
                    ],
                    "Name": "ip-read-barcodes",
                    "ScaleDownThreshold": 9999,
                    "ScaleUpModes": [
                        {
                            "AcuteAngleWithXThreshold": -1,
                            "LetterHeightThreshold": 0,
                            "Mode": "SUM_AUTO",
                            "ModuleSizeThreshold": 0,
                            "TargetLetterHeight": 0,
                            "TargetModuleSize": 0
                        }
                    ]
                }
            ],
            "TargetROIDefOptions": [
                {
                    "Name": "roi-read-barcodes",
                    "TaskSettingNameArray": [
                        "task-read-barcodes"
                    ]
                }
            ]
        }`)
        scanner.templateName = 'ReadBarcodes_Default';
    }
  </script>
</body>
</html>
